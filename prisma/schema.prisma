// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  phone     String?
  age       Int?
  role      Role     @default(STUDENT)
  status    String   @default("active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  teacherProfile  TeacherProfile?
  studentProfile  StudentProfile?

  @@index([role])
  @@index([email])
  @@map("user")
}

model Speciality {
  id       Int        @id @default(autoincrement())
  name     String     @unique
  description String? @db.Text
  teachers TeacherProfile[]

  @@map("speciality")
}

model Career {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  totalCicles     Int              @map("total_cicles")
  durationYears   Int              @map("duration_years")
  teachers        TeacherProfile[]
  students        StudentProfile[]
  subjects        Subject[]

  @@map("career")
}

model TeacherProfile {
  id           Int        @id @default(autoincrement())
  userId       Int        @unique @map("user_id")
  specialityId Int        @map("speciality_id")
  careerId     Int        @map("career_id")
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  speciality   Speciality @relation(fields: [specialityId], references: [id])
  career       Career     @relation(fields: [careerId], references: [id])
  subjects     Subject[]

  @@map("teacher_profile")
}

model StudentProfile {
  id              Int              @id @default(autoincrement())
  userId          Int              @unique @map("user_id")
  careerId        Int              @map("career_id")
  currentCicle    Int              @map("current_cicle")
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  career          Career           @relation(fields: [careerId], references: [id])
  studentSubjects StudentSubject[]

  @@index([careerId, currentCicle])
  @@map("student_profile")
}

model Subject {
  id               Int              @id @default(autoincrement())
  name             String
  careerId         Int              @map("career_id")
  cicleNumber      Int              @map("cicle_number")
  teacherProfileId Int?             @map("teacher_profile_id")
  career           Career           @relation(fields: [careerId], references: [id])
  teacherProfile   TeacherProfile?  @relation(fields: [teacherProfileId], references: [id])
  studentSubjects  StudentSubject[]

  @@unique([careerId, cicleNumber, name])
  @@index([careerId, cicleNumber])
  @@map("subject")
}

model StudentSubject {
  id               Int            @id @default(autoincrement())
  studentProfileId Int            @map("student_profile_id")
  subjectId        Int            @map("subject_id")
  grade            Decimal?       @db.Decimal(5, 2)
  status           String         @default("enrolled")
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  subject          Subject        @relation(fields: [subjectId], references: [id])

  @@unique([studentProfileId, subjectId])
  @@map("student_subject")
}
